<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login Test - Debug</title>
    <style>
        body {
            font-family: monospace;
            padding: 20px;
            background: #1a1a1a;
            color: #fff;
        }

        .log {
            background: #2a2a2a;
            padding: 10px;
            margin: 5px 0;
            border-left: 3px solid #4CAF50;
        }

        .error {
            border-left-color: #f44336;
        }

        .warn {
            border-left-color: #ff9800;
        }

        button {
            padding: 10px 20px;
            margin: 10px 5px;
            cursor: pointer;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
        }

        input {
            padding: 8px;
            margin: 5px;
            background: #2a2a2a;
            color: white;
            border: 1px solid #444;
            border-radius: 4px;
        }
    </style>
</head>

<body>
    <h1>Login Flow Debug Test</h1>
    <div>
        <input type="text" id="phone" placeholder="Phone (9876543210)" value="9876543210">
        <select id="role">
            <option value="customer">Customer</option>
            <option value="worker">Worker</option>
        </select>
        <button onclick="testLogin()">Test Login</button>
        <button onclick="checkStorage()">Check Storage</button>
        <button onclick="clearLogs()">Clear Logs</button>
    </div>
    <div id="logs"></div>

    <script type="module">
        import { apiFetch } from '../../js/api.js';

        // Make apiFetch available globally
        window.apiFetch = apiFetch;

        // Override Storage to use window.Storage
        window.Storage = {
            get: (key) => {
                const val = sessionStorage.getItem(key);
                try {
                    return JSON.parse(val);
                } catch {
                    return val;
                }
            },
            set: (key, val) => {
                sessionStorage.setItem(key, typeof val === 'string' ? val : JSON.stringify(val));
            },
            remove: (key) => {
                sessionStorage.removeItem(key);
            },
            clear: () => {
                sessionStorage.clear();
            }
        };

        log('✓ Modules loaded successfully');
    </script>

    <script>
        function log(message, type = 'log') {
            const div = document.createElement('div');
            div.className = `log ${type}`;
            div.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            document.getElementById('logs').appendChild(div);
            console.log(message);
        }

        function clearLogs() {
            document.getElementById('logs').innerHTML = '';
        }

        async function testLogin() {
            const phone = document.getElementById('phone').value;
            const role = document.getElementById('role').value;

            log(`Starting login test...`);
            log(`Phone: ${phone}, Role: ${role}`);

            try {
                // Format phone
                const formattedPhone = phone.startsWith('+') ? phone.replace(/\s+/g, '') : `+91${phone.replace(/\s+/g, '')}`;
                log(`Formatted phone: ${formattedPhone}`);

                // Call API
                log(`Calling API: POST /auth/login`);
                const response = await window.apiFetch('/auth/login', {
                    method: 'POST',
                    body: JSON.stringify({
                        idToken: 'mock-token',
                        phone: formattedPhone,
                        role
                    })
                });

                log(`✓ API Response received`, 'log');
                log(`Response: ${JSON.stringify(response, null, 2)}`);

                // Create user data
                const userData = {
                    uid: response.user.uid,
                    name: response.user.name,
                    email: response.user.email,
                    phone: formattedPhone,
                    role,
                    loggedIn: true,
                    loginTime: new Date().toISOString()
                };

                log(`User data created: ${JSON.stringify(userData, null, 2)}`);

                // Store in session
                window.Storage.set('karyasetu_user', userData);
                window.Storage.set('karyasetu_user_role', role);

                log(`✓ Data stored in sessionStorage`, 'log');

                // Verify storage
                const stored = window.Storage.get('karyasetu_user');
                log(`Verification - Retrieved from storage: ${JSON.stringify(stored, null, 2)}`);

                // Determine redirect
                const redirectUrl = role === 'customer'
                    ? '/pages/dashboard/customer/customer-dashboard.html'
                    : '/pages/dashboard/worker/worker-dashboard.html';

                log(`✓ Should redirect to: ${redirectUrl}`, 'log');
                log(`Click the link to test: <a href="${redirectUrl}" style="color: #4CAF50;">${redirectUrl}</a>`);

            } catch (error) {
                log(`✗ ERROR: ${error.message}`, 'error');
                log(`Stack: ${error.stack}`, 'error');
            }
        }

        function checkStorage() {
            log('=== Storage Check ===');
            const user = window.Storage.get('karyasetu_user');
            const role = window.Storage.get('karyasetu_user_role');

            log(`User data: ${JSON.stringify(user, null, 2)}`);
            log(`Role: ${role}`);

            if (user && user.loggedIn) {
                log(`✓ User is logged in`, 'log');
            } else {
                log(`✗ User is NOT logged in`, 'warn');
            }
        }
    </script>
</body>

</html>