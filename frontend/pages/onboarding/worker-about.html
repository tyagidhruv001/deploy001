<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Worker Onboarding - KaryaSetu</title>
    <link rel="stylesheet" href="../../css/theme.css">
    <link rel="stylesheet" href="../../css/main.css">
    <link rel="stylesheet" href="./onboarding.css">
</head>

<body>
    <div class="onboarding-container gradient-mesh">
        <div class="onboarding-card card-glass">
            <div class="onboarding-header">
                <div class="logo">
                    <span class="logo-icon">ğŸ”§</span>
                    <span class="logo-text">KaryaSetu</span>
                </div>
                <h1>Worker Profile Setup</h1>
                <p>Complete your profile to start receiving jobs</p>
            </div>

            <form class="onboarding-form" id="workerOnboardingForm">
                <div class="input-group">
                    <label class="input-label">Select Your Skills (Select all that apply)</label>
                    <div class="skills-grid">
                        <label class="skill-checkbox">
                            <input type="checkbox" value="Mechanic">
                            <span>ğŸ”§ Mechanic</span>
                        </label>
                        <label class="skill-checkbox">
                            <input type="checkbox" value="Plumber">
                            <span>ğŸš° Plumber</span>
                        </label>
                        <label class="skill-checkbox">
                            <input type="checkbox" value="Electrician">
                            <span>âš¡ Electrician</span>
                        </label>
                        <label class="skill-checkbox">
                            <input type="checkbox" value="Carpenter">
                            <span>ğŸªš Carpenter</span>
                        </label>
                        <label class="skill-checkbox">
                            <input type="checkbox" value="Painter">
                            <span>ğŸ¨ Painter</span>
                        </label>
                        <label class="skill-checkbox">
                            <input type="checkbox" value="Home Cleaning">
                            <span>ğŸ§¹ Home Cleaning</span>
                        </label>
                        <label class="skill-checkbox">
                            <input type="checkbox" value="AC Repair">
                            <span>â„ï¸ AC Repair</span>
                        </label>
                        <label class="skill-checkbox">
                            <input type="checkbox" value="Gardening">
                            <span>ğŸŒ± Gardening</span>
                        </label>
                        <label class="skill-checkbox">
                            <input type="checkbox" value="Appliances">
                            <span>ğŸ“º Appliances</span>
                        </label>
                        <label class="skill-checkbox">
                            <input type="checkbox" value="Pest Control">
                            <span>ğŸœ Pest Control</span>
                        </label>
                        <label class="skill-checkbox">
                            <input type="checkbox" value="Beauty & Spa">
                            <span>ğŸ’† Beauty & Spa</span>
                        </label>
                        <label class="skill-checkbox">
                            <input type="checkbox" value="Packers & Movers">
                            <span>ğŸ“¦ Packers & Movers</span>
                        </label>
                        <label class="skill-checkbox">
                            <input type="checkbox" value="RO & Water">
                            <span>ğŸ’§ RO & Water</span>
                        </label>
                        <label class="skill-checkbox">
                            <input type="checkbox" value="Home Security">
                            <span>ğŸ›¡ï¸ Home Security</span>
                        </label>
                        <label class="skill-checkbox">
                            <input type="checkbox" value="Interior Design">
                            <span>ğŸ›‹ï¸ Interior Design</span>
                        </label>
                    </div>
                </div>

                <div class="input-group">
                    <label class="input-label">Experience Level</label>
                    <select class="input-field" id="experience" required>
                        <option value="">Select experience</option>
                        <option value="beginner">Beginner (0-2 years)</option>
                        <option value="skilled">Skilled (2-5 years)</option>
                        <option value="expert">Expert (5+ years)</option>
                    </select>
                </div>

                <div class="input-group">
                    <label class="input-label">Location</label>
                    <input type="text" class="input-field" id="location" placeholder="Enter your city" required>
                </div>

                <div class="input-group">
                    <label class="input-label">Hourly Rate (â‚¹)</label>
                    <input type="number" class="input-field" id="hourlyRate" placeholder="e.g., 200" min="50" required>
                </div>

                <div class="input-group">
                    <label class="input-label">Government ID (Aadhaar/PAN)</label>
                    <input type="file" class="input-field" id="govId" accept="image/*,.pdf">
                    <span class="input-helper">Upload for verification (optional for demo)</span>
                </div>

                <button type="submit" class="btn btn-primary btn-lg">Complete Setup</button>
            </form>
        </div>
    </div>

    <script type="module" src="../../js/config.js"></script>
    <script type="module" src="../../js/api.js"></script>
    <script type="module" src="../../js/utils.js"></script>
    <script type="module">
        // Check if user is logged in
        const userData = Storage.get('karyasetu_user');
        if (!userData || !userData.loggedIn) {
            window.location.href = '../auth/login.html';
        }

        document.getElementById('workerOnboardingForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const skills = Array.from(document.querySelectorAll('.skill-checkbox input:checked')).map(cb => cb.value);

            if (skills.length === 0) {
                showToast('Please select at least one skill', 'error');
                return;
            }

            const btn = e.target.querySelector('button[type="submit"]');
            const originalText = btn.textContent;
            btn.textContent = 'Saving Profile...';
            btn.disabled = true;

            const experience = document.getElementById('experience').value;
            const location = document.getElementById('location').value;
            const hourlyRate = parseInt(document.getElementById('hourlyRate').value);

            const profile = {
                skills,
                experience,
                location,
                hourlyRate,
                role: 'worker',
                verified: false,
                rating: 0,
                jobsCompleted: 0,
                createdAt: new Date().toISOString()
            };

            try {
                // 1. Sync to backend Firestore collection
                // Map to the backend expected schema in routes/workers.js
                const workerBackendData = {
                    category: skills[0], // Use primary skill as category
                    is_online: true,
                    base_price: hourlyRate,
                    experience_years: experience === 'expert' ? 10 : (experience === 'skilled' ? 4 : 1),
                    location: { lat: 26.7600, lng: 77.8900 }, // Default to seeded area if no geo
                    bio: `Professional ${skills[0]} with ${experience} experience.`,
                    verification_status: 'pending'
                };

                await API.workers.register(userData.uid, workerBackendData);

                // 2. Update Local Storage
                Storage.set('karyasetu_user_profile', profile);

                // 3. Update User role/metadata
                const updatedUser = { ...userData, profile_complete: true };
                Storage.set('karyasetu_user', updatedUser);

                showToast('Profile created and synced!', 'success');

                setTimeout(() => {
                    window.location.href = '../dashboard/worker/worker-dashboard.html';
                }, 1000);

            } catch (error) {
                console.error('Failed to sync profile:', error);
                showToast('Save failed: ' + error.message, 'error');
                btn.textContent = originalText;
                btn.disabled = false;
            }
        });
    </script>
</body>

</html>