<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Map Tracking Test | KaryaSetu</title>

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #0f0f0f;
            color: #fff;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: rgba(30, 32, 58, 0.95);
            backdrop-filter: blur(10px);
            padding: 1rem 1.5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .header h1 {
            font-size: 1.3rem;
            background: linear-gradient(135deg, #00d2ff, #a855f7);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .controls {
            display: flex;
            gap: 0.5rem;
        }

        .btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #fff;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
        }

        .btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }

        .btn.active {
            background: #00d2ff;
            color: #000;
            border-color: #00d2ff;
        }

        #map {
            flex: 1;
            z-index: 1;
        }

        .info-panel {
            position: absolute;
            top: 80px;
            right: 20px;
            background: rgba(30, 32, 58, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 1.5rem;
            min-width: 280px;
            z-index: 1000;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .info-panel h3 {
            font-size: 1rem;
            margin-bottom: 1rem;
            color: #00d2ff;
        }

        .info-item {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .info-item:last-child {
            border-bottom: none;
        }

        .info-label {
            opacity: 0.7;
        }

        .info-value {
            font-weight: 600;
            color: #00ff88;
        }

        .simulator {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(30, 32, 58, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 1.5rem;
            z-index: 1000;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .simulator h3 {
            font-size: 1rem;
            margin-bottom: 1rem;
            color: #a855f7;
        }

        .sim-controls {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.5rem;
        }

        .sim-btn {
            background: rgba(168, 85, 247, 0.2);
            border: 1px solid #a855f7;
            color: #fff;
            padding: 0.7rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.2s;
        }

        .sim-btn:hover {
            background: rgba(168, 85, 247, 0.4);
            transform: scale(1.05);
        }

        .route-line {
            stroke: #00d2ff;
            stroke-width: 3;
            stroke-dasharray: 10, 5;
            animation: dash 20s linear infinite;
        }

        @keyframes dash {
            to {
                stroke-dashoffset: -1000;
            }
        }
    </style>
</head>

<body>
    <div class="header">
        <h1>üó∫Ô∏è Live Map Tracking Test</h1>
        <div class="controls">
            <button class="btn" onclick="resetMap()">Reset</button>
            <button class="btn active" id="autoupdate-btn" onclick="toggleAutoUpdate()">Auto-Update ON</button>
        </div>
    </div>

    <div id="map"></div>

    <div class="info-panel">
        <h3>üìä Tracking Info</h3>
        <div class="info-item">
            <span class="info-label">Distance:</span>
            <span class="info-value" id="distance">-- km</span>
        </div>
        <div class="info-item">
            <span class="info-label">ETA:</span>
            <span class="info-value" id="eta">-- min</span>
        </div>
        <div class="info-item">
            <span class="info-label">Customer:</span>
            <span class="info-value" id="customer-status">Fixed</span>
        </div>
        <div class="info-item">
            <span class="info-label">Worker:</span>
            <span class="info-value" id="worker-status">Moving</span>
        </div>
        <div class="info-item">
            <span class="info-label">Last Update:</span>
            <span class="info-value" id="last-update">--</span>
        </div>
    </div>

    <div class="simulator">
        <h3>üéÆ Worker Movement Simulator</h3>
        <div class="sim-controls">
            <button class="sim-btn" onclick="moveWorker('up')">‚¨ÜÔ∏è North</button>
            <button class="sim-btn" onclick="moveWorker('right')">‚û°Ô∏è East</button>
            <button class="sim-btn" onclick="moveWorker('down')">‚¨áÔ∏è South</button>
            <button class="sim-btn" onclick="moveWorker('left')">‚¨ÖÔ∏è West</button>
            <button class="sim-btn" onclick="moveWorker('random')">üé≤ Random</button>
            <button class="sim-btn" onclick="moveWorkerToCustomer()">üè† To Customer</button>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        // Auto-detect API URL (works on local network)
        const hostname = window.location.hostname;
        const API_URL = `http://${hostname}:5000`;
        console.log('Using API URL:', API_URL);

        const BOOKING_ID = 'test-booking-123';
        const CUSTOMER_ID = 'test-customer-001';
        const WORKER_ID = 'test-worker-001';

        // Initial positions (Delhi, India area)
        let customerPos = { lat: 28.6139, lng: 77.2090 }; // Customer fixed position
        let workerPos = { lat: 28.6239, lng: 77.2190 };   // Worker starts nearby

        let map, customerMarker, workerMarker, routeLine;
        let autoUpdate = true;

        // Initialize map
        function initMap() {
            map = L.map('map').setView([customerPos.lat, customerPos.lng], 14);

            // Add tile layer
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors',
                maxZoom: 19
            }).addTo(map);

            // Custom icons
            const customerIcon = L.divIcon({
                html: '<div style="background:#00d2ff;width:30px;height:30px;border-radius:50%;border:3px solid white;display:flex;align-items:center;justify-content:center;font-size:1.2rem;">üè†</div>',
                iconSize: [30, 30],
                className: ''
            });

            const workerIcon = L.divIcon({
                html: '<div style="background:#00ff88;width:30px;height:30px;border-radius:50%;border:3px solid white;display:flex;align-items:center;justify-content:center;font-size:1.2rem;">üë∑</div>',
                iconSize: [30, 30],
                className: ''
            });

            // Add markers
            customerMarker = L.marker([customerPos.lat, customerPos.lng], { icon: customerIcon })
                .addTo(map)
                .bindPopup('<b>Customer Location</b><br>Home Address');

            workerMarker = L.marker([workerPos.lat, workerPos.lng], { icon: workerIcon })
                .addTo(map)
                .bindPopup('<b>Worker Location</b><br>En route to customer');

            // Draw initial route line
            updateRouteLine();
            updateInfo();
        }

        function updateRouteLine() {
            if (routeLine) {
                map.removeLayer(routeLine);
            }

            routeLine = L.polyline(
                [[customerPos.lat, customerPos.lng], [workerPos.lat, workerPos.lng]],
                {
                    color: '#00d2ff',
                    weight: 3,
                    opacity: 0.7,
                    dashArray: '10, 10'
                }
            ).addTo(map);
        }

        function updateInfo() {
            const distance = calculateDistance(
                customerPos.lat, customerPos.lng,
                workerPos.lat, workerPos.lng
            );

            const eta = Math.round((distance / 0.4) * 60); // Assuming 24 km/h average speed

            document.getElementById('distance').textContent = distance.toFixed(2) + ' km';
            document.getElementById('eta').textContent = eta + ' min';
            document.getElementById('last-update').textContent = new Date().toLocaleTimeString();
        }

        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Earth radius in km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }

        // Move worker in different directions
        function moveWorker(direction) {
            const step = 0.002; // ~200 meters

            switch (direction) {
                case 'up':
                    workerPos.lat += step;
                    break;
                case 'down':
                    workerPos.lat -= step;
                    break;
                case 'left':
                    workerPos.lng -= step;
                    break;
                case 'right':
                    workerPos.lng += step;
                    break;
                case 'random':
                    workerPos.lat += (Math.random() - 0.5) * step * 2;
                    workerPos.lng += (Math.random() - 0.5) * step * 2;
                    break;
            }

            updateWorkerPosition();
        }

        function moveWorkerToCustomer() {
            // Move worker 20% closer to customer
            workerPos.lat += (customerPos.lat - workerPos.lat) * 0.2;
            workerPos.lng += (customerPos.lng - workerPos.lng) * 0.2;
            updateWorkerPosition();
        }

        async function updateWorkerPosition() {
            // Update marker on map
            workerMarker.setLatLng([workerPos.lat, workerPos.lng]);
            updateRouteLine();
            updateInfo();

            // Send to backend
            try {
                const response = await fetch(`${API_URL}/api/location/${BOOKING_ID}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        userId: WORKER_ID,
                        userType: 'worker',
                        latitude: workerPos.lat,
                        longitude: workerPos.lng
                    })
                });

                if (response.ok) {
                    console.log('Location updated in backend');
                }
            } catch (error) {
                console.error('Failed to update location:', error);
            }
        }

        function resetMap() {
            workerPos = { lat: 28.6239, lng: 77.2190 };
            workerMarker.setLatLng([workerPos.lat, workerPos.lng]);
            updateRouteLine();
            updateInfo();
        }

        function toggleAutoUpdate() {
            autoUpdate = !autoUpdate;
            const btn = document.getElementById('autoupdate-btn');
            btn.textContent = autoUpdate ? 'Auto-Update ON' : 'Auto-Update OFF';
            btn.classList.toggle('active');
        }

        // Auto-move worker towards customer (simulation)
        setInterval(() => {
            if (autoUpdate) {
                moveWorkerToCustomer();
            }
        }, 3000);

        // Initialize on load
        window.addEventListener('load', initMap);
    </script>
</body>

</html>